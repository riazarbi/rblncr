<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Balance or Die • rblncr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Balance or Die">
<meta property="og:description" content="rblncr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rblncr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.9.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/balance_or_die.html">Balance or Die</a>
    </li>
    <li>
      <a href="../articles/introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/scheduled_rebalance.html">Scheduled rebalancing</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/riazarbi/rblncr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Balance or Die</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/riazarbi/rblncr/blob/HEAD/vignettes/balance_or_die.Rmd" class="external-link"><code>vignettes/balance_or_die.Rmd</code></a></small>
      <div class="hidden name"><code>balance_or_die.Rmd</code></div>

    </div>

    
    
<p>If you want to use <code>rblncr</code> to rebalance a portfolio
periodically, you might want to just keep calling
<code>rebalance_portfolio()</code> until the portfolio is balanced. You
can achieve this with a <code>while</code> loop.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://riazarbi.github.io/rblncr/" class="external-link">rblncr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>First we set our connection details.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trading_mode</span> <span class="op">=</span> <span class="st">"paper"</span></span>
<span><span class="va">alpaca_paper_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"ALPACA_PAPER_KEY"</span><span class="op">)</span></span>
<span><span class="va">alpaca_paper_secret</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"ALPACA_PAPER_SECRET"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">alpaca_live_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"ALPACA_LIVE_KEY"</span><span class="op">)</span></span>
<span><span class="va">alpaca_live_secret</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"ALPACA_LIVE_SECRET"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">t_conn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/alpaca_connect.html">alpaca_connect</a></span><span class="op">(</span><span class="va">trading_mode</span>,</span>
<span>                         <span class="va">alpaca_paper_key</span>,</span>
<span>                         <span class="va">alpaca_paper_secret</span><span class="op">)</span></span>
<span><span class="va">d_conn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/alpaca_connect.html">alpaca_connect</a></span><span class="op">(</span><span class="st">"data"</span>,</span>
<span>                         <span class="va">alpaca_live_key</span>,</span>
<span>                         <span class="va">alpaca_live_secret</span><span class="op">)</span></span></code></pre></div>
<p>Then we create or load our model. Here we want a portoflio that is
70.% AAPL, and 19.5% GOOG. The remaining 10% will sit in cash.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"sample_portfolio"</span></span>
<span><span class="va">description</span> <span class="op">&lt;-</span> <span class="st">"create from function"</span></span>
<span><span class="va">cash</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">assets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>symbol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AAPL"</span>,<span class="st">"GOOG"</span><span class="op">)</span>, percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">60</span>,<span class="fl">30</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tolerance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>percent <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">cooldown</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>days <span class="op">=</span> <span class="fl">365</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_portfolio_model.html">create_portfolio_model</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">name</span>,</span>
<span>                      description <span class="op">=</span> <span class="va">description</span>,</span>
<span>                      cash <span class="op">=</span> <span class="va">cash</span>,</span>
<span>                      assets <span class="op">=</span> <span class="va">assets</span>,</span>
<span>                      tolerance <span class="op">=</span> <span class="va">tolerance</span>,</span>
<span>                      cooldown <span class="op">=</span> <span class="va">cooldown</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">balanced</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">attempts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">while</span><span class="op">(</span><span class="op">!</span><span class="va">balanced</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span><span class="va">attempt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/balance_portfolio.html">balance_portfolio</a></span><span class="op">(</span><span class="va">model</span>,</span>
<span>                             trading_connection <span class="op">=</span> <span class="va">t_conn</span>,</span>
<span>                             pricing_connection <span class="op">=</span> <span class="va">d_conn</span>,</span>
<span>                             min_order_size <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                             max_order_size <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>                             daily_vol_pct_limit <span class="op">=</span> <span class="fl">0.02</span>,</span>
<span>                             pricing_spread_tolerance <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>                             pricing_overrides <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                             trader_life <span class="op">=</span> <span class="fl">60</span>,</span>
<span>                             buy_only <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                             resubmit_interval <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                             verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">balanced</span> <span class="op">&lt;-</span> <span class="va">attempt</span><span class="op">$</span><span class="va">portfolio_balanced</span></span>
<span><span class="va">attempts</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">attempt</span></span>
<span><span class="va">i</span> <span class="op">&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">attempts</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">drift_changes</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span><span class="va">attempts</span>, <span class="op">~</span> <span class="va">.x</span><span class="op">$</span><span class="va">drift</span>, .id <span class="op">=</span> <span class="st">"run"</span><span class="op">)</span></span>
<span>  <span class="va">drift_changes</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">drift_changes</span>, run <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">run</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>These are the trades attempted by the <code><a href="../reference/trader.html">trader()</a></code>. The
orders with <code>NA</code> timestamps were not even submitted to the
broker because they didn’t have sufficient information. Generally this
happens when the order quantity is zero, or the data connection did not
return sufficient information to create a limit order.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trades</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span><span class="va">attempts</span>, <span class="op">~</span> <span class="va">.x</span><span class="op">$</span><span class="va">trades</span>, .id <span class="op">=</span> <span class="st">"run"</span><span class="op">)</span></span>
<span><span class="va">trades</span></span>
<span><span class="co">#&gt;   run           timestamp symbol order  limit filled   status</span></span>
<span><span class="co">#&gt; 1   1 2024-03-12 14:45:13   AAPL   -57 172.66    -57   filled</span></span>
<span><span class="co">#&gt; 2   1 2024-03-12 14:45:13   GOOG    71 139.67     71   filled</span></span>
<span><span class="co">#&gt; 3   2 2024-03-12 14:45:31   AAPL   -57 172.68    -57   filled</span></span>
<span><span class="co">#&gt; 4   2 2024-03-12 14:45:32   GOOG    71 139.10      0 canceled</span></span>
<span><span class="co">#&gt; 5   2                &lt;NA&gt;   GOOG    71     NA      0 no_limit</span></span>
<span><span class="co">#&gt; 6   2 2024-03-12 14:46:00   GOOG    71 139.05      0 canceled</span></span>
<span><span class="co">#&gt; 7   2                &lt;NA&gt;   GOOG    71     NA      0 no_limit</span></span>
<span><span class="co">#&gt; 8   2 2024-03-12 14:46:28   GOOG    71 139.62     71   filled</span></span></code></pre></div>
<p>We can see how the portfolio drift converges to zero over time.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">attempts</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">drift_changes</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">run</span>, y <span class="op">=</span> <span class="va">drift</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">symbol</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="balance_or_die_files/figure-html/plot_drift-1.png" width="700"></p>
<p>Here are the portfolio weights post-rebalance. You can see that we
have managed to achieve our target balances (within tolerance).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/get_portfolio_current.html">get_portfolio_current</a></span><span class="op">(</span><span class="va">t_conn</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/price_portfolio.html">price_portfolio</a></span><span class="op">(</span><span class="va">d_conn</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">extract2</a></span><span class="op">(</span><span class="st">"assets"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">symbol</span>, <span class="va">percent_held</span><span class="op">)</span></span>
<span><span class="co">#&gt;   symbol percent_held</span></span>
<span><span class="co">#&gt; 1   AAPL        59.97</span></span>
<span><span class="co">#&gt; 2   GOOG        29.97</span></span></code></pre></div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Riaz Arbi.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
